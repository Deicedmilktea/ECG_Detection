#ifndef FIR_H
#define FIR_H

#include "stdint.h"

#define FILTER_TAPS 181 // 滤波器阶数

float coeffs[FILTER_TAPS] = {
    1.939705863e-18, 0.000232159975, 0.0002789109712, 9.324662096e-05, -0.0001836826996,
    -0.0003255770134, -0.0002004677081, 0.0001109399527, 0.0003609354899, 0.0003257369099,
    -1.259290252e-18, -0.0003697601205, -0.0004645876179, -0.0001615776127, 0.0003293180198,
    0.0006007585907, 0.0003787857131, -0.0002136440453, -0.0007053618319, -0.0006434956449,
    -8.364509291e-19, 0.000739130599, 0.0009304012056, 0.0003234766191, -0.0006578819593,
    -0.00119578396, -0.0007503046654, 0.0004207296297, 0.001379942754, 0.001249909168,
    -3.623305441e-18, -0.001413577236, -0.001765040681, -0.0006086557405, 0.001227758476,
    0.002213470405, 0.001377710025, -0.0007664522855, -0.002494501416, -0.002242509043,
    1.577892017e-17, 0.002500125207, 0.003100758884, 0.001062390395, -0.002129897708,
    -0.003817617428, -0.002363164444, 0.001307940227, 0.004236496519, 0.00379171758,
    -7.245186477e-18, -0.004194836132, -0.0051856637, -0.001771670417, 0.003543282859,
    0.006338419858, 0.003917648457, -0.002166072838, -0.007012404036, -0.006276306696,
    8.999823499e-18, 0.006955934223, 0.00861474406, 0.00295065972, -0.005920577794,
    -0.01063438412, -0.006605596747, 0.003673949745, 0.01197736338, 0.01080793049,
    -1.043021565e-17, -0.01222517714, -0.01533240173, -0.005328103434, 0.01087027416,
    0.0199019108, 0.01263759658, -0.007210176904, -0.02421095408, -0.02261413634,
    1.136383869e-17, 0.02795354091, 0.03714657202, 0.01385225169, -0.03085253946,
    -0.06318230182, -0.04653945193, 0.03268710524, 0.1511125565, 0.2573043108,
    0.2998349667, 0.2573043108, 0.1511125565, 0.03268710524, -0.04653945193,
    -0.06318230182, -0.03085253946, 0.01385225169, 0.03714657202, 0.02795354091,
    1.136383869e-17, -0.02261413634, -0.02421095408, -0.007210176904, 0.01263759658,
    0.0199019108, 0.01087027416, -0.005328103434, -0.01533240173, -0.01222517714,
    -1.043021565e-17, 0.01080793049, 0.01197736338, 0.003673949745, -0.006605596747,
    -0.01063438412, -0.005920577794, 0.00295065972, 0.00861474406, 0.006955934223,
    8.999823499e-18, -0.006276306696, -0.007012404036, -0.002166072838, 0.003917648457,
    0.006338419858, 0.003543282859, -0.001771670417, -0.0051856637, -0.004194836132,
    -7.245186477e-18, 0.00379171758, 0.004236496519, 0.001307940227, -0.002363164444,
    -0.003817617428, -0.002129897708, 0.001062390395, 0.003100758884, 0.002500125207,
    1.577892017e-17, -0.002242509043, -0.002494501416, -0.0007664522855, 0.001377710025,
    0.002213470405, 0.001227758476, -0.0006086557405, -0.001765040681, -0.001413577236,
    -3.623305441e-18, 0.001249909168, 0.001379942754, 0.0004207296297, -0.0007503046654,
    -0.00119578396, -0.0006578819593, 0.0003234766191, 0.0009304012056, 0.000739130599,
    -8.364509291e-19, -0.0006434956449, -0.0007053618319, -0.0002136440453, 0.0003787857131,
    0.0006007585907, 0.0003293180198, -0.0001615776127, -0.0004645876179, -0.0003697601205,
    -1.259290252e-18, 0.0003257369099, 0.0003609354899, 0.0001109399527, -0.0002004677081,
    -0.0003255770134, -0.0001836826996, 9.324662096e-05, 0.0002789109712, 0.000232159975,
    1.939705863e-18};

float filter_state[FILTER_TAPS] = {0}; // 初始化滤波器状态为零

float FIR_filter(int16_t input)
{
    float output = 0.0f;

    // 更新滤波器状态，移位并插入新的输入值
    for (int i = FILTER_TAPS - 1; i > 0; i--)
    {
        filter_state[i] = filter_state[i - 1];
    }
    filter_state[0] = input;

    // 计算滤波器输出（卷积运算）
    for (int i = 0; i < FILTER_TAPS; i++)
    {
        output += filter_state[i] * coeffs[i];
    }

    // 返回最终的输出值，限制为16位整数范围
    if (output > 32767.0f)
        output = 32767.0f;
    else if (output < -32768.0f)
        output = -32768.0f;

    return (int16_t)output; // 返回16位整数类型的滤波结果
}

#endif // !FIR_H
