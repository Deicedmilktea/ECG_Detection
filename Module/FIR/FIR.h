#ifndef FIR_H
#define FIR_H

#include "stdint.h"

#define FILTER_TAPS 161 // 滤波器阶数

float coeffs[FILTER_TAPS] = {
    -0.000302955223929, -0.0003233688475234, -0.0003008594554442, -0.0002355852404501,
    -0.0001321747305861, 4.1587877849e-19, 0.000146913261546, 0.000290558880951,
    0.0004103820819496, 0.0004855269641246, 0.0004977788688598, 0.0004348772729467,
    0.0002936899125243, 8.262076063493e-05, -0.0001773855368569, -0.0004537578174334,
    -0.0007053916139435, -0.0008878229377704, -0.0009599745446149, -0.0008915785306866,
    -0.0006700914245867, -0.0003058016181107, 0.0001660675236298, 0.0006871183240629,
    0.001181719347185, 0.001566761543989, 0.001764151066207, 0.001714333039493,
    0.001388723293396, 0.0007988168091468, -1.703823411692e-18, -0.000911280280303,
    -0.001807407026241, -0.002545843438898, -0.002989910356177, -0.003031292224733,
    -0.002610854423643, -0.00173422288089, -0.0004790060851177, 0.001008480193566,
    0.002527694443676, 0.003848568172621, 0.004743711406082, 0.005023940413521,
    0.00457197350531, 0.003368876639478, 0.00150839078924, -0.0008043708669659,
    -0.003271339902854, -0.005536057004147, -0.007230878519896, -0.008031070068812,
    -0.007708434125769, -0.006176467156349, -0.003519513405283, 3.724246483243e-18,
    0.003959542679925, 0.007819652211421, 0.01098868010675, 0.01290212256356,
    0.01310688999051, 0.01133935732854, 0.007585960584307, 0.002116570268329,
    -0.004516224120371, -0.01151475315739, -0.01790898943447, -0.02265779037832,
    -0.02476796656302, -0.02341751848093, -0.01806804573055, -0.008551867128969,
    0.004878192367224, 0.02154433374988, 0.04038738988917, 0.06005549441541,
    0.0790292285406, 0.09576999777585, 0.1088752549336, 0.1172230069339,
    0.120089002858, 0.1172230069339, 0.1088752549336, 0.09576999777585,
    0.0790292285406, 0.06005549441541, 0.04038738988917, 0.02154433374988,
    0.004878192367224, -0.008551867128969, -0.01806804573055, -0.02341751848093,
    -0.02476796656302, -0.02265779037832, -0.01790898943447, -0.01151475315739,
    -0.004516224120371, 0.002116570268329, 0.007585960584307, 0.01133935732854,
    0.01310688999051, 0.01290212256356, 0.01098868010675, 0.007819652211421,
    0.003959542679925, 3.724246483243e-18, -0.003519513405283, -0.006176467156349,
    -0.007708434125769, -0.008031070068812, -0.007230878519896, -0.005536057004147,
    -0.003271339902854, -0.0008043708669659, 0.00150839078924, 0.003368876639478,
    0.00457197350531, 0.005023940413521, 0.004743711406082, 0.003848568172621,
    0.002527694443676, 0.001008480193566, -0.0004790060851177, -0.00173422288089,
    -0.002610854423643, -0.003031292224733, -0.002989910356177, -0.002545843438898,
    -0.001807407026241, -0.000911280280303, -1.703823411692e-18, 0.0007988168091468,
    0.001388723293396, 0.001714333039493, 0.001764151066207, 0.001566761543989,
    0.001181719347185, 0.0006871183240629, 0.0001660675236298, -0.0003058016181107,
    -0.0006700914245867, -0.0008915785306866, -0.0009599745446149, -0.0008878229377704,
    -0.0007053916139435, -0.0004537578174334, -0.0001773855368569, 8.262076063493e-05,
    0.0002936899125243, 0.0004348772729467, 0.0004977788688598, 0.0004855269641246,
    0.0004103820819496, 0.000290558880951, 0.000146913261546, 4.1587877849e-19,
    -0.0001321747305861, -0.0002355852404501, -0.0003008594554442, -0.0003233688475234,
    -0.000302955223929};

float filter_state[FILTER_TAPS] = {0}; // 初始化滤波器状态为零

float FIR_filter(int16_t input)
{
    float output = 0.0f;

    // 更新滤波器状态，移位并插入新的输入值
    for (int i = FILTER_TAPS - 1; i > 0; i--)
    {
        filter_state[i] = filter_state[i - 1];
    }
    filter_state[0] = input;

    // 计算滤波器输出（卷积运算）
    for (int i = 0; i < FILTER_TAPS; i++)
    {
        output += filter_state[i] * coeffs[i];
    }

    // 返回最终的输出值，限制为16位整数范围
    if (output > 32767.0f)
        output = 32767.0f;
    else if (output < -32768.0f)
        output = -32768.0f;

    return (int16_t)output; // 返回16位整数类型的滤波结果
}

#endif // !FIR_H
